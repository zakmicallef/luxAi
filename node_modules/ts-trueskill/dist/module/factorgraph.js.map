{"version":3,"file":"factorgraph.js","sourceRoot":"","sources":["../../src/factorgraph.ts"],"names":[],"mappings":"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","sourcesContent":["import { v1 as uuid } from 'uuid';\n\nimport { SkillGaussian } from './mathematics';\nimport { Rating } from './rating';\n\nexport class Variable extends SkillGaussian {\n  messages: { [key: string]: SkillGaussian } = {};\n\n  setVal(val: Variable | SkillGaussian): number {\n    const delta = this.delta(val);\n    this.pi = val.pi;\n    this.tau = val.tau;\n    return delta;\n  }\n\n  delta(other: Variable | SkillGaussian): number {\n    const piDelta = Math.abs(this.pi - other.pi);\n    if (piDelta === Infinity) {\n      return 0;\n    }\n\n    return Math.max(Math.abs(this.tau - other.tau), Math.sqrt(piDelta));\n  }\n\n  updateMessage(\n    factor: LikelihoodFactor | SumFactor | PriorFactor,\n    pi = 0,\n    tau = 0,\n    message?: SkillGaussian,\n  ): number {\n    const newMessage = message ? message : new SkillGaussian(null, null, pi, tau);\n    const str = factor.toString();\n    const oldMessage = this.messages[str];\n    this.messages[str] = newMessage;\n    return this.setVal(this.div(oldMessage).mul(newMessage));\n  }\n\n  updateValue(\n    factor: TruncateFactor | PriorFactor,\n    pi = 0,\n    tau = 0,\n    value?: SkillGaussian,\n  ): number {\n    if (!value) {\n      value = new SkillGaussian(null, null, pi, tau);\n    }\n\n    const oldMessage = this.messages[factor.toString()];\n    this.messages[factor.toString()] = value.mul(oldMessage).div(this);\n    return this.setVal(value);\n  }\n\n  toString(): string {\n    const count = Object.keys(this.messages).length;\n    const s = count === 1 ? '' : 's';\n    const val = super.toString();\n    return `<Variable ${val} with ${count} connection${s}>`;\n  }\n}\n\nexport class Factor {\n  readonly uuid: string;\n\n  constructor(public vars: Variable[]) {\n    this.uuid = uuid();\n    const k = this.toString();\n    vars.forEach(v => {\n      v.messages[k] = new SkillGaussian();\n    });\n  }\n\n  down(): number {\n    return 0;\n  }\n\n  up(): number {\n    return 0;\n  }\n\n  get v(): Variable {\n    if (this.vars.length !== 1) {\n      throw new Error('Too long');\n    }\n\n    return this.vars[0];\n  }\n\n  toString(): string {\n    const s = this.vars.length === 1 ? '' : 's';\n    return `<Factor with ${this.vars.length} connection${s} ${this.uuid}>`;\n  }\n}\n\nexport class PriorFactor extends Factor {\n  constructor(v: Variable, readonly val: Rating, readonly dynamic = 0) {\n    super([v]);\n  }\n\n  down(): number {\n    const sigma = Math.sqrt((this.val.sigma ** 2) + (this.dynamic ** 2));\n    const value = new SkillGaussian(this.val.mu, sigma);\n    return this.v.updateValue(this, undefined, undefined, value);\n  }\n}\n\nexport class LikelihoodFactor extends Factor {\n  constructor(\n    readonly mean: Variable,\n    readonly value: Variable,\n    readonly variance: number,\n  ) {\n    super([mean, value]);\n  }\n\n  calcA(v: SkillGaussian): number {\n    return 1.0 / ((this.variance * v.pi) + 1.0);\n  }\n\n  down(): number {\n    const msg = this.mean.div(this.mean.messages[this.toString()]);\n    const a = this.calcA(msg);\n    return this.value.updateMessage(this, a * msg.pi, a * msg.tau);\n  }\n\n  up(): number {\n    const msg = this.value.div(this.value.messages[this.toString()]);\n    const a = this.calcA(msg);\n    return this.mean.updateMessage(this, a * msg.pi, a * msg.tau);\n  }\n}\n\nexport class SumFactor extends Factor {\n  constructor(\n    readonly sum: Variable,\n    readonly terms: Variable[],\n    readonly coeffs: number[],\n  ) {\n    super([sum].concat(terms));\n  }\n\n  down(): number {\n    const k = this.toString();\n    const msgs = this.terms.map(v => v.messages[k]);\n    return this.update(this.sum, this.terms, msgs, this.coeffs);\n  }\n\n  up(index = 0): number {\n    const coeff = this.coeffs[index];\n    let x = 0;\n    const coeffs = this.coeffs.map(c => {\n      let p = -c / coeff;\n      if (x === index) {\n        p = 1.0 / coeff;\n      }\n\n      p = Number.isFinite(p) ? p : 0;\n      if (coeff === 0) {\n        p = 0;\n      }\n\n      x += 1;\n      return p;\n    });\n    const vals = [...this.terms];\n    vals[index] = this.sum;\n    const k = this.toString();\n    const msgs = vals.map(v => v.messages[k]);\n    return this.update(this.terms[index], vals, msgs, coeffs);\n  }\n\n  update(\n    v: Variable,\n    vals: Variable[],\n    msgs: SkillGaussian[],\n    coeffs: number[],\n  ): number {\n    let piInv = 0;\n    let mu = 0;\n    for (let i = 0; i < vals.length; i++) {\n      const val = vals[i];\n      const msg = msgs[i];\n      const coeff = coeffs[i];\n      const div = val.div(msg);\n      mu += coeff * div.mu;\n      if (!Number.isFinite(piInv)) {\n        continue;\n      }\n\n      piInv += (coeff ** 2) / div.pi;\n    }\n\n    const pi = 1.0 / piInv;\n    const tau = pi * mu;\n    return v.updateMessage(this, pi, tau);\n  }\n}\n\nexport class TruncateFactor extends Factor {\n  constructor(\n    v: Variable,\n    readonly vFunc: (a: number, b: number) => number,\n    readonly wFunc: (a: number, b: number) => number,\n    readonly drawMargin: number,\n  ) {\n    super([v]);\n  }\n\n  up(): number {\n    const val = this.v;\n    const msg = this.v.messages[this.toString()];\n    const div = val.div(msg);\n    const sqrtPi = Math.sqrt(div.pi);\n    const v = this.vFunc(div.tau / sqrtPi, this.drawMargin * sqrtPi);\n    const w = this.wFunc(div.tau / sqrtPi, this.drawMargin * sqrtPi);\n    const denom = 1.0 - w;\n    const pi = div.pi / denom;\n    const tau = (div.tau + (sqrtPi * v)) / denom;\n    return val.updateValue(this, pi, tau);\n  }\n}\n"]}